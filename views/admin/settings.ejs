<%- include("../partials/head", { title: "Bula Admin - Settings", assetVersion }) %>

<body>
  <div class="app">
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <%- include("../partials/sidebar", { activeMenu: "settings" }) %>

    <div class="main">
      <%- include("../partials/topbar", { admin }) %>

      <div class="content">
        <div class="page-title">
          <h2>Business Settings</h2>
          <div class="muted">Configure your business details, branding, and captive portal appearance</div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="business">Business Info</button>
          <button class="tab-btn" data-tab="branding">Branding</button>
          <button class="tab-btn" data-tab="portal">Captive Portal</button>
          <button class="tab-btn" data-tab="theme">Theme</button>
          <button class="tab-btn" data-tab="payments">Payments</button>
          <button class="tab-btn" data-tab="mikrotik">MikroTik</button>
          <button class="tab-btn" data-tab="support">Support</button>
        </div>

        <!-- Business Info Tab -->
        <div class="tab-content active" id="tab-business">
          <div class="card">
            <div class="card-head">
              <h3>Business Information</h3>
            </div>
            <form id="businessInfoForm" class="settings-form">
              <div class="form-grid">
                <div class="form-group">
                  <label for="business_name">Business Name</label>
                  <input type="text" id="business_name" name="business_name" value="<%= settings.business_name || '' %>" placeholder="Your Business Name">
                </div>
                <div class="form-group">
                  <label for="tagline">Tagline</label>
                  <input type="text" id="tagline" name="tagline" value="<%= settings.tagline || '' %>" placeholder="Short description">
                </div>
              </div>

              <div class="form-group">
                <label for="address">Address</label>
                <textarea id="address" name="address" rows="2" placeholder="Business address"><%= settings.address || '' %></textarea>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="phone">Phone Number</label>
                  <input type="tel" id="phone" name="phone" value="<%= settings.phone || '' %>" placeholder="+256 xxx xxx xxx">
                </div>
                <div class="form-group">
                  <label for="email">Email Address</label>
                  <input type="email" id="email" name="email" value="<%= settings.email || '' %>" placeholder="contact@business.com">
                </div>
              </div>

              <div class="form-group">
                <label for="website">Website</label>
                <input type="url" id="website" name="website" value="<%= settings.website || '' %>" placeholder="https://www.example.com">
              </div>

              <h4 class="form-section-title">Social Media Links</h4>
              <div class="form-grid form-grid--3">
                <div class="form-group">
                  <label for="facebook_url">Facebook</label>
                  <input type="url" id="facebook_url" name="facebook_url" value="<%= settings.facebook_url || '' %>" placeholder="https://facebook.com/...">
                </div>
                <div class="form-group">
                  <label for="twitter_url">Twitter / X</label>
                  <input type="url" id="twitter_url" name="twitter_url" value="<%= settings.twitter_url || '' %>" placeholder="https://twitter.com/...">
                </div>
                <div class="form-group">
                  <label for="instagram_url">Instagram</label>
                  <input type="url" id="instagram_url" name="instagram_url" value="<%= settings.instagram_url || '' %>" placeholder="https://instagram.com/...">
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn--primary">Save Business Info</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Branding Tab -->
        <div class="tab-content" id="tab-branding">
          <div class="card">
            <div class="card-head">
              <h3>Company Logo</h3>
            </div>
            <div class="upload-section">
              <div class="upload-preview" id="logoPreview">
                <% if (settings.logo_url) { %>
                  <img src="<%= settings.logo_url %>" alt="Company Logo">
                <% } else { %>
                  <div class="upload-placeholder">
                    <i data-lucide="image"></i>
                    <span>No logo uploaded</span>
                  </div>
                <% } %>
              </div>
              <div class="upload-actions">
                <input type="file" id="logoInput" accept="image/*" style="display: none;">
                <button type="button" class="btn btn--primary" onclick="document.getElementById('logoInput').click()">
                  <i data-lucide="upload"></i> Upload Logo
                </button>
                <% if (settings.logo_url) { %>
                <button type="button" class="btn btn--danger" onclick="deleteImage('logo_url')">
                  <i data-lucide="trash-2"></i> Remove
                </button>
                <% } %>
              </div>
              <p class="upload-help">Recommended: PNG or JPG, max 5MB. Square images work best.</p>
            </div>
          </div>

          <div class="card mt-16">
            <div class="card-head">
              <h3>Favicon</h3>
            </div>
            <div class="upload-section">
              <div class="upload-preview upload-preview--small" id="faviconPreview">
                <% if (settings.favicon_url) { %>
                  <img src="<%= settings.favicon_url %>" alt="Favicon">
                <% } else { %>
                  <div class="upload-placeholder">
                    <i data-lucide="square"></i>
                    <span>No favicon</span>
                  </div>
                <% } %>
              </div>
              <div class="upload-actions">
                <input type="file" id="faviconInput" accept="image/*" style="display: none;">
                <button type="button" class="btn btn--primary" onclick="document.getElementById('faviconInput').click()">
                  <i data-lucide="upload"></i> Upload Favicon
                </button>
                <% if (settings.favicon_url) { %>
                <button type="button" class="btn btn--danger" onclick="deleteImage('favicon_url')">
                  <i data-lucide="trash-2"></i> Remove
                </button>
                <% } %>
              </div>
              <p class="upload-help">Recommended: 32x32 or 64x64 pixels, PNG format.</p>
            </div>
          </div>
        </div>

        <!-- Captive Portal Tab -->
        <div class="tab-content" id="tab-portal">
          <div class="card">
            <div class="card-head">
              <h3>Portal Appearance</h3>
            </div>
            <form id="portalForm" class="settings-form">
              <div class="form-grid">
                <div class="form-group">
                  <label for="portal_title">Portal Title</label>
                  <input type="text" id="portal_title" name="portal_title" value="<%= settings.portal_title || '' %>" placeholder="Welcome to WiFi">
                </div>
                <div class="form-group">
                  <label for="portal_background_color">Background Color</label>
                  <div class="color-input-wrapper">
                    <input type="color" id="portal_background_color_picker" value="<%= settings.portal_background_color || '#f7f8fa' %>">
                    <input type="text" id="portal_background_color" name="portal_background_color" value="<%= settings.portal_background_color || '#f7f8fa' %>" placeholder="#f7f8fa">
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label for="portal_welcome_text">Welcome Message</label>
                <textarea id="portal_welcome_text" name="portal_welcome_text" rows="3" placeholder="Welcome message for the captive portal"><%= settings.portal_welcome_text || '' %></textarea>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn--primary">Save Portal Settings</button>
                <a href="/portal" target="_blank" class="btn">
                  <i data-lucide="external-link"></i> Preview Portal
                </a>
              </div>
            </form>
          </div>

          <div class="card mt-16">
            <div class="card-head">
              <h3>Portal Background Image</h3>
            </div>
            <div class="upload-section">
              <div class="upload-preview upload-preview--wide" id="backgroundPreview">
                <% if (settings.portal_background_url) { %>
                  <img src="<%= settings.portal_background_url %>" alt="Background">
                <% } else { %>
                  <div class="upload-placeholder">
                    <i data-lucide="image"></i>
                    <span>No background image</span>
                  </div>
                <% } %>
              </div>
              <div class="upload-actions">
                <input type="file" id="backgroundInput" accept="image/*" style="display: none;">
                <button type="button" class="btn btn--primary" onclick="document.getElementById('backgroundInput').click()">
                  <i data-lucide="upload"></i> Upload Background
                </button>
                <% if (settings.portal_background_url) { %>
                <button type="button" class="btn btn--danger" onclick="deleteImage('portal_background_url')">
                  <i data-lucide="trash-2"></i> Remove
                </button>
                <% } %>
              </div>
              <p class="upload-help">Recommended: 1920x1080 or larger for best results.</p>
            </div>
          </div>

          <div class="card mt-16">
            <div class="card-head">
              <h3>Terms & Privacy</h3>
            </div>
            <form id="termsForm" class="settings-form">
              <div class="form-grid">
                <div class="form-group">
                  <label for="terms_url">Terms of Service URL</label>
                  <input type="url" id="terms_url" name="terms_url" value="<%= settings.terms_url || '' %>" placeholder="https://...">
                </div>
                <div class="form-group">
                  <label for="privacy_url">Privacy Policy URL</label>
                  <input type="url" id="privacy_url" name="privacy_url" value="<%= settings.privacy_url || '' %>" placeholder="https://...">
                </div>
              </div>

              <div class="form-group">
                <label for="terms_text">Terms Text (displayed on portal)</label>
                <textarea id="terms_text" name="terms_text" rows="4" placeholder="By connecting, you agree to our terms..."><%= settings.terms_text || '' %></textarea>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn--primary">Save Terms Settings</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Theme Tab -->
        <div class="tab-content" id="tab-theme">
          <div class="card">
            <div class="card-head">
              <h3>Color Scheme</h3>
            </div>
            <form id="themeForm" class="settings-form">
              <div class="form-grid form-grid--3">
                <div class="form-group">
                  <label for="primary_color">Primary Color</label>
                  <div class="color-input-wrapper">
                    <input type="color" id="primary_color_picker" value="<%= settings.primary_color || '#0ea56b' %>">
                    <input type="text" id="primary_color" name="primary_color" value="<%= settings.primary_color || '#0ea56b' %>" placeholder="#0ea56b">
                  </div>
                </div>
                <div class="form-group">
                  <label for="primary_light">Primary Light</label>
                  <div class="color-input-wrapper">
                    <input type="color" id="primary_light_picker" value="<%= settings.primary_light || '#e6f6ef' %>">
                    <input type="text" id="primary_light" name="primary_light" value="<%= settings.primary_light || '#e6f6ef' %>" placeholder="#e6f6ef">
                  </div>
                </div>
                <div class="form-group">
                  <label for="primary_dark">Primary Dark</label>
                  <div class="color-input-wrapper">
                    <input type="color" id="primary_dark_picker" value="<%= settings.primary_dark || '#0b8a59' %>">
                    <input type="text" id="primary_dark" name="primary_dark" value="<%= settings.primary_dark || '#0b8a59' %>" placeholder="#0b8a59">
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label for="theme_mode">Theme Mode</label>
                <select id="theme_mode" name="theme_mode">
                  <option value="light" <%= settings.theme_mode === 'light' ? 'selected' : '' %>>Light Mode</option>
                  <option value="dark" <%= settings.theme_mode === 'dark' ? 'selected' : '' %>>Dark Mode</option>
                  <option value="auto" <%= settings.theme_mode === 'auto' ? 'selected' : '' %>>Auto (System Preference)</option>
                </select>
              </div>

              <div class="color-preview">
                <h4>Preview</h4>
                <div class="preview-box" id="themePreview">
                  <div class="preview-header" style="background: <%= settings.primary_color || '#0ea56b' %>">
                    <span style="color: white; font-weight: 600;"><%= settings.business_name || 'Your Business' %></span>
                  </div>
                  <div class="preview-content">
                    <button class="preview-btn" style="background: <%= settings.primary_color || '#0ea56b' %>; color: white;">Primary Button</button>
                    <button class="preview-btn" style="background: <%= settings.primary_light || '#e6f6ef' %>; color: <%= settings.primary_color || '#0ea56b' %>;">Secondary Button</button>
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn--primary">Save Theme</button>
                <button type="button" class="btn" onclick="resetThemeColors()">Reset to Defaults</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Payments Tab -->
        <div class="tab-content" id="tab-payments">
          <!-- Flutterwave -->
          <div class="card">
            <div class="card-head">
              <div class="card-head__title">
                <h3>Flutterwave</h3>
                <span class="provider-status" id="flw-status">Loading...</span>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="flw_enabled">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <form id="flutterwaveForm" class="settings-form">
              <div class="form-group">
                <label for="flw_environment">Environment</label>
                <select id="flw_environment" name="environment">
                  <option value="test">Test (Sandbox)</option>
                  <option value="live">Live (Production)</option>
                </select>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="flw_public_key">Public Key</label>
                  <input type="text" id="flw_public_key" name="public_key" placeholder="FLWPUBK-xxxxxxxx">
                </div>
                <div class="form-group">
                  <label for="flw_secret_key">Secret Key</label>
                  <div class="password-input">
                    <input type="password" id="flw_secret_key" name="secret_key" placeholder="FLWSECK-xxxxxxxx">
                    <button type="button" class="password-toggle" onclick="togglePassword('flw_secret_key')">
                      <i data-lucide="eye"></i>
                    </button>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label for="flw_webhook_hash">Webhook Secret Hash</label>
                <div class="password-input">
                  <input type="password" id="flw_webhook_hash" name="webhook_hash" placeholder="Your webhook secret hash">
                  <button type="button" class="password-toggle" onclick="togglePassword('flw_webhook_hash')">
                    <i data-lucide="eye"></i>
                  </button>
                </div>
              </div>

              <div class="webhook-info">
                <label>Webhook URL</label>
                <div class="webhook-url">
                  <code id="flw_webhook_url"></code>
                  <button type="button" class="btn btn--sm" onclick="copyWebhookUrl('flw_webhook_url')">
                    <i data-lucide="copy"></i> Copy
                  </button>
                </div>
                <p class="form-help">Add this URL to your Flutterwave dashboard webhook settings.</p>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn--primary">Save Flutterwave Settings</button>
              </div>
            </form>
          </div>

          <!-- Yo Payments -->
          <div class="card mt-16">
            <div class="card-head">
              <div class="card-head__title">
                <h3>Yo Payments</h3>
                <span class="provider-status" id="yo-status">Loading...</span>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="yo_enabled">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <form id="yopaymentsForm" class="settings-form">
              <div class="form-group">
                <label for="yo_environment">Environment</label>
                <select id="yo_environment" name="environment">
                  <option value="test">Test (Sandbox)</option>
                  <option value="live">Live (Production)</option>
                </select>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="yo_api_username">API Username</label>
                  <input type="text" id="yo_api_username" name="api_username" placeholder="Your Yo Payments username">
                </div>
                <div class="form-group">
                  <label for="yo_api_password">API Password</label>
                  <div class="password-input">
                    <input type="password" id="yo_api_password" name="api_password" placeholder="Your API password">
                    <button type="button" class="password-toggle" onclick="togglePassword('yo_api_password')">
                      <i data-lucide="eye"></i>
                    </button>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label for="yo_account_number">Account Number</label>
                <input type="text" id="yo_account_number" name="account_number" placeholder="Your Yo Payments account number">
              </div>

              <div class="webhook-info">
                <label>IPN (Webhook) URL</label>
                <div class="webhook-url">
                  <code id="yo_webhook_url"></code>
                  <button type="button" class="btn btn--sm" onclick="copyWebhookUrl('yo_webhook_url')">
                    <i data-lucide="copy"></i> Copy
                  </button>
                </div>
                <p class="form-help">Add this URL as the IPN notification URL in your Yo Payments account.</p>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn--primary">Save Yo Payments Settings</button>
              </div>
            </form>
          </div>

          <!-- Payment Provider Info -->
          <div class="card mt-16">
            <div class="card-head">
              <h3>Payment Integration Guide</h3>
            </div>
            <div class="info-section">
              <h4>Flutterwave</h4>
              <p>Accept payments via cards, mobile money (MTN, Airtel), and bank transfers across Africa.</p>
              <ol>
                <li>Create an account at <a href="https://flutterwave.com" target="_blank">flutterwave.com</a></li>
                <li>Get your API keys from Settings > API Keys</li>
                <li>Copy the Webhook URL above and add it in Settings > Webhooks</li>
                <li>Enable the provider and save</li>
              </ol>

              <h4 class="mt-16">Yo Payments</h4>
              <p>Accept mobile money payments in Uganda (MTN and Airtel).</p>
              <ol>
                <li>Register at <a href="https://yopayments.com" target="_blank">yopayments.com</a></li>
                <li>Get your API credentials from your account dashboard</li>
                <li>Set up the IPN URL in your Yo Payments account</li>
                <li>Enable the provider and save</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- MikroTik Tab -->
        <div class="tab-content" id="tab-mikrotik">
          <div class="card">
            <div class="card-head">
              <div class="card-head__title">
                <h3>MikroTik Router Integration</h3>
                <span class="provider-status" id="mikrotik-status">
                  <%= settings.mikrotik_enabled ? 'Enabled' : 'Disabled' %>
                </span>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="mikrotik_enabled" <%= settings.mikrotik_enabled ? 'checked' : '' %>>
                <span class="toggle-slider"></span>
              </label>
            </div>
            <form id="mikrotikForm" class="settings-form">
              <div class="info-section" style="margin-bottom: 20px; padding: 16px; background: var(--primary-light); border-radius: var(--radius); border-left: 4px solid var(--primary);">
                <p style="margin: 0; font-size: 0.9375rem;">
                  <strong>Auto-Login Feature:</strong> When enabled, customers will be automatically connected to WiFi after successful payment. Their MAC address is captured from the MikroTik hotspot redirect and authorized via the RouterOS API.
                </p>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="mikrotik_host">Router IP Address</label>
                  <input type="text" id="mikrotik_host" name="mikrotik_host" value="<%= settings.mikrotik_host || '' %>" placeholder="e.g., 192.168.88.1">
                  <p class="form-help">IP address of your MikroTik router</p>
                </div>
                <div class="form-group">
                  <label for="mikrotik_port">API Port</label>
                  <input type="number" id="mikrotik_port" name="mikrotik_port" value="<%= settings.mikrotik_port || 8728 %>" placeholder="8728">
                  <p class="form-help">Default: 8728 (API), 8729 (API-SSL)</p>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="mikrotik_username">API Username</label>
                  <input type="text" id="mikrotik_username" name="mikrotik_username" value="<%= settings.mikrotik_username || '' %>" placeholder="admin">
                  <p class="form-help">User with API and write access</p>
                </div>
                <div class="form-group">
                  <label for="mikrotik_password">API Password</label>
                  <div class="password-input">
                    <input type="password" id="mikrotik_password" name="mikrotik_password" value="<%= settings.mikrotik_password || '' %>" placeholder="Router password">
                    <button type="button" class="password-toggle" onclick="togglePassword('mikrotik_password')">
                      <i data-lucide="eye"></i>
                    </button>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label for="mikrotik_hotspot_server">Hotspot Server Name</label>
                <input type="text" id="mikrotik_hotspot_server" name="mikrotik_hotspot_server" value="<%= settings.mikrotik_hotspot_server || '' %>" placeholder="hotspot1">
                <p class="form-help">Name of the hotspot server in MikroTik (leave blank for "all")</p>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn--primary">Save MikroTik Settings</button>
                <button type="button" class="btn" id="testMikrotikBtn" onclick="testMikrotikConnection()">
                  <i data-lucide="wifi"></i> Test Connection
                </button>
              </div>
            </form>

            <div id="mikrotikTestResult" style="display: none; margin-top: 16px; padding: 16px; border-radius: var(--radius);"></div>
          </div>

          <div class="card mt-16">
            <div class="card-head">
              <h3>MikroTik Setup Instructions</h3>
            </div>
            <div class="info-section">
              <h4>1. Enable API Access on MikroTik</h4>
              <p>In WinBox or terminal, enable the API service:</p>
              <pre style="background: var(--bg); padding: 12px; border-radius: var(--radius-sm); margin: 12px 0; overflow-x: auto;">/ip service enable api
/ip service set api port=8728</pre>

              <h4 class="mt-16">2. Create API User (Recommended)</h4>
              <p>Create a dedicated user with API and write permissions:</p>
              <pre style="background: var(--bg); padding: 12px; border-radius: var(--radius-sm); margin: 12px 0; overflow-x: auto;">/user add name=bula-api password=YOUR_SECURE_PASSWORD group=full</pre>

              <h4 class="mt-16">3. Configure Hotspot Walled Garden</h4>
              <p>Add your portal domain to the walled garden so users can access it before authentication:</p>
              <pre style="background: var(--bg); padding: 12px; border-radius: var(--radius-sm); margin: 12px 0; overflow-x: auto;">/ip hotspot walled-garden add dst-host=bula.prosystemsug.com action=allow
/ip hotspot walled-garden ip add dst-address=YOUR_PORTAL_SERVER_IP action=accept</pre>

              <h4 class="mt-16">4. Configure Hotspot Login Page</h4>
              <p>Set your portal as the login page and include MAC parameter:</p>
              <pre style="background: var(--bg); padding: 12px; border-radius: var(--radius-sm); margin: 12px 0; overflow-x: auto;">/ip hotspot profile set default login-by=http-chap,http-pap html-directory=hotspot
/ip hotspot profile set default login-by=cookie,http-chap http-cookie-lifetime=1d</pre>

              <h4 class="mt-16">5. How It Works</h4>
              <ol style="margin: 12px 0; padding-left: 20px;">
                <li>Customer connects to WiFi and is redirected to MikroTik login page</li>
                <li>MikroTik redirects to your portal with MAC address in URL: <code>/portal?mac=XX:XX:XX:XX:XX:XX</code></li>
                <li>Customer completes payment on your portal</li>
                <li>After payment, the system creates an IP binding for the MAC address</li>
                <li>Customer is automatically connected - no voucher code entry needed!</li>
              </ol>

              <h4 class="mt-16">Fallback Behavior</h4>
              <p>If auto-login fails (router unreachable, API error, etc.), customers will see their voucher code and can connect manually.</p>
            </div>
          </div>
        </div>

        <!-- Support Tab -->
        <div class="tab-content" id="tab-support">
          <div class="card">
            <div class="card-head">
              <h3>Customer Support Information</h3>
            </div>
            <form id="supportForm" class="settings-form">
              <div class="form-grid">
                <div class="form-group">
                  <label for="support_phone">Support Phone</label>
                  <input type="tel" id="support_phone" name="support_phone" value="<%= settings.support_phone || '' %>" placeholder="+256 xxx xxx xxx">
                </div>
                <div class="form-group">
                  <label for="support_email">Support Email</label>
                  <input type="email" id="support_email" name="support_email" value="<%= settings.support_email || '' %>" placeholder="support@business.com">
                </div>
              </div>

              <div class="form-group">
                <label for="support_hours">Support Hours</label>
                <input type="text" id="support_hours" name="support_hours" value="<%= settings.support_hours || '' %>" placeholder="e.g., Mon-Fri 9am-5pm EAT">
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn--primary">Save Support Info</button>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>

  <style>
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.9375rem;
      font-weight: 500;
      border-radius: var(--radius-sm);
      transition: all 0.15s ease;
    }

    .tab-btn:hover {
      background: var(--bg);
      color: var(--text);
    }

    .tab-btn.active {
      background: var(--primary-light);
      color: var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .settings-form {
      max-width: 800px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .form-grid--3 {
      grid-template-columns: repeat(3, 1fr);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 6px;
    }

    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="tel"],
    .form-group input[type="url"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 0.9375rem;
      color: var(--text);
      background: var(--white);
      transition: border-color 0.15s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-group textarea {
      resize: vertical;
    }

    .form-section-title {
      margin: 24px 0 16px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .upload-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .upload-preview {
      width: 200px;
      height: 200px;
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: var(--bg);
    }

    .upload-preview--small {
      width: 100px;
      height: 100px;
    }

    .upload-preview--wide {
      width: 100%;
      max-width: 600px;
      height: 300px;
    }

    .upload-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .upload-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
    }

    .upload-placeholder svg {
      width: 48px;
      height: 48px;
    }

    .upload-actions {
      display: flex;
      gap: 12px;
    }

    .upload-help {
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    .color-input-wrapper {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .color-input-wrapper input[type="color"] {
      width: 40px;
      height: 40px;
      padding: 0;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      background: none;
    }

    .color-input-wrapper input[type="text"] {
      flex: 1;
    }

    .color-preview {
      margin-top: 24px;
    }

    .color-preview h4 {
      margin-bottom: 12px;
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .preview-box {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      max-width: 400px;
    }

    .preview-header {
      padding: 16px;
    }

    .preview-content {
      padding: 20px;
      display: flex;
      gap: 12px;
      background: var(--white);
    }

    .preview-btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .btn--danger {
      background: #fee2e2;
      color: #991b1b;
      border-color: #fecaca;
    }

    .btn--danger:hover {
      background: #fecaca;
    }

    /* Payment Tab Styles */
    .card-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-head__title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-head__title h3 {
      margin: 0;
    }

    .provider-status {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 500;
    }

    .provider-status.enabled {
      background: #dcfce7;
      color: #166534;
    }

    .provider-status.disabled {
      background: #fee2e2;
      color: #991b1b;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 26px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--primary);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }

    .password-input {
      position: relative;
      display: flex;
      align-items: center;
    }

    .password-input input {
      flex: 1;
      padding-right: 40px;
    }

    .password-toggle {
      position: absolute;
      right: 8px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .password-toggle:hover {
      color: var(--text);
    }

    .password-toggle svg {
      width: 18px;
      height: 18px;
    }

    .webhook-info {
      margin-top: 16px;
      padding: 16px;
      background: var(--bg);
      border-radius: var(--radius);
    }

    .webhook-info label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 8px;
    }

    .webhook-url {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--white);
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
    }

    .webhook-url code {
      flex: 1;
      font-size: 0.8125rem;
      color: var(--text);
      word-break: break-all;
    }

    .btn--sm {
      padding: 6px 12px;
      font-size: 0.75rem;
    }

    .form-help {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .info-section {
      font-size: 0.9375rem;
      line-height: 1.6;
    }

    .info-section h4 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .info-section ol {
      margin: 12px 0;
      padding-left: 20px;
    }

    .info-section li {
      margin-bottom: 6px;
    }

    .info-section a {
      color: var(--primary);
      text-decoration: none;
    }

    .info-section a:hover {
      text-decoration: underline;
    }

    .mt-16 {
      margin-top: 16px;
    }

    @media (max-width: 768px) {
      .form-grid,
      .form-grid--3 {
        grid-template-columns: 1fr;
      }

      .upload-preview--wide {
        height: 200px;
      }
    }
  </style>

  <script src="/js/app.js?v=<%= assetVersion || '' %>"></script>
  <script>
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      });
    });

    // Color picker sync
    document.querySelectorAll('input[type="color"]').forEach(picker => {
      const textId = picker.id.replace('_picker', '');
      const textInput = document.getElementById(textId);
      if (textInput) {
        picker.addEventListener('input', () => {
          textInput.value = picker.value;
          updateThemePreview();
        });
        textInput.addEventListener('input', () => {
          if (/^#[0-9A-Fa-f]{6}$/.test(textInput.value)) {
            picker.value = textInput.value;
            updateThemePreview();
          }
        });
      }
    });

    function updateThemePreview() {
      const primary = document.getElementById('primary_color').value;
      const primaryLight = document.getElementById('primary_light').value;
      const header = document.querySelector('.preview-header');
      const btns = document.querySelectorAll('.preview-btn');
      if (header && primary) {
        header.style.background = primary;
      }
      if (btns[0] && primary) {
        btns[0].style.background = primary;
      }
      if (btns[1] && primaryLight && primary) {
        btns[1].style.background = primaryLight;
        btns[1].style.color = primary;
      }
    }

    function resetThemeColors() {
      document.getElementById('primary_color').value = '#0ea56b';
      document.getElementById('primary_color_picker').value = '#0ea56b';
      document.getElementById('primary_light').value = '#e6f6ef';
      document.getElementById('primary_light_picker').value = '#e6f6ef';
      document.getElementById('primary_dark').value = '#0b8a59';
      document.getElementById('primary_dark_picker').value = '#0b8a59';
      updateThemePreview();
    }

    // Form submissions
    async function submitForm(formId, excludeFields = []) {
      const form = document.getElementById(formId);
      const formData = new FormData(form);
      const data = {};
      for (const [key, value] of formData.entries()) {
        if (!excludeFields.includes(key)) {
          data[key] = value;
        }
      }

      try {
        const response = await fetch('/admin/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.ok) {
          showToast('Settings saved successfully');
        } else {
          showToast(result.message || 'Failed to save settings', 'error');
        }
      } catch (e) {
        showToast('Error saving settings', 'error');
      }
    }

    document.getElementById('businessInfoForm').addEventListener('submit', (e) => {
      e.preventDefault();
      submitForm('businessInfoForm');
    });

    document.getElementById('portalForm').addEventListener('submit', (e) => {
      e.preventDefault();
      submitForm('portalForm');
    });

    document.getElementById('termsForm').addEventListener('submit', (e) => {
      e.preventDefault();
      submitForm('termsForm');
    });

    document.getElementById('themeForm').addEventListener('submit', (e) => {
      e.preventDefault();
      submitForm('themeForm');
    });

    document.getElementById('supportForm').addEventListener('submit', (e) => {
      e.preventDefault();
      submitForm('supportForm');
    });

    // Image uploads
    async function uploadImage(field, file) {
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const response = await fetch(`/admin/api/settings/upload/${field}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: e.target.result })
          });
          const result = await response.json();
          if (result.ok) {
            showToast('Image uploaded successfully');
            location.reload();
          } else {
            showToast(result.message || 'Upload failed', 'error');
          }
        } catch (err) {
          showToast('Error uploading image', 'error');
        }
      };
      reader.readAsDataURL(file);
    }

    document.getElementById('logoInput').addEventListener('change', (e) => {
      if (e.target.files[0]) uploadImage('logo_url', e.target.files[0]);
    });

    document.getElementById('faviconInput').addEventListener('change', (e) => {
      if (e.target.files[0]) uploadImage('favicon_url', e.target.files[0]);
    });

    document.getElementById('backgroundInput').addEventListener('change', (e) => {
      if (e.target.files[0]) uploadImage('portal_background_url', e.target.files[0]);
    });

    async function deleteImage(field) {
      if (!confirm('Are you sure you want to delete this image?')) return;

      try {
        const response = await fetch(`/admin/api/settings/upload/${field}`, {
          method: 'DELETE'
        });
        const result = await response.json();
        if (result.ok) {
          showToast('Image deleted');
          location.reload();
        } else {
          showToast(result.message || 'Delete failed', 'error');
        }
      } catch (e) {
        showToast('Error deleting image', 'error');
      }
    }

    // Toast notifications
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = 'toast toast--' + type;
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'error' ? '#991b1b' : '#0ea56b'};
        color: white;
        border-radius: 8px;
        font-size: 0.875rem;
        z-index: 1000;
        animation: slideIn 0.3s ease;
      `;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Add animation styles
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    // Payment Provider Management
    const baseUrl = window.location.origin;

    // Set webhook URLs
    document.getElementById('flw_webhook_url').textContent = `${baseUrl}/api/payments/flutterwave/webhook`;
    document.getElementById('yo_webhook_url').textContent = `${baseUrl}/api/payments/yopayments/webhook`;

    // Load payment providers
    async function loadPaymentProviders() {
      try {
        const response = await fetch('/admin/api/payment-providers');
        const result = await response.json();
        if (result.ok) {
          result.providers.forEach(provider => {
            if (provider.provider_code === 'flutterwave') {
              populateFlutterwaveForm(provider);
            } else if (provider.provider_code === 'yopayments') {
              populateYoPaymentsForm(provider);
            }
          });
        }
      } catch (e) {
        console.error('Error loading payment providers:', e);
      }
    }

    function populateFlutterwaveForm(provider) {
      document.getElementById('flw_enabled').checked = provider.is_enabled === 1;
      document.getElementById('flw_environment').value = provider.environment || 'test';
      document.getElementById('flw_public_key').value = provider.credentials?.public_key || '';
      document.getElementById('flw_secret_key').value = provider.credentials?.secret_key || '';
      document.getElementById('flw_webhook_hash').value = provider.credentials?.webhook_hash || '';
      updateProviderStatus('flw', provider.is_enabled === 1);
    }

    function populateYoPaymentsForm(provider) {
      document.getElementById('yo_enabled').checked = provider.is_enabled === 1;
      document.getElementById('yo_environment').value = provider.environment || 'test';
      document.getElementById('yo_api_username').value = provider.credentials?.api_username || '';
      document.getElementById('yo_api_password').value = provider.credentials?.api_password || '';
      document.getElementById('yo_account_number').value = provider.credentials?.account_number || '';
      updateProviderStatus('yo', provider.is_enabled === 1);
    }

    function updateProviderStatus(prefix, enabled) {
      const statusEl = document.getElementById(`${prefix}-status`);
      if (enabled) {
        statusEl.textContent = 'Enabled';
        statusEl.className = 'provider-status enabled';
      } else {
        statusEl.textContent = 'Disabled';
        statusEl.className = 'provider-status disabled';
      }
    }

    // Toggle password visibility
    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      const icon = input.parentElement.querySelector('i');
      if (input.type === 'password') {
        input.type = 'text';
        icon.setAttribute('data-lucide', 'eye-off');
      } else {
        input.type = 'password';
        icon.setAttribute('data-lucide', 'eye');
      }
      lucide.createIcons();
    }

    // Copy webhook URL
    function copyWebhookUrl(elementId) {
      const url = document.getElementById(elementId).textContent;
      navigator.clipboard.writeText(url).then(() => {
        showToast('Webhook URL copied to clipboard');
      }).catch(() => {
        showToast('Failed to copy URL', 'error');
      });
    }

    // Save Flutterwave settings
    document.getElementById('flutterwaveForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const response = await fetch('/admin/api/payment-providers/flutterwave', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            is_enabled: document.getElementById('flw_enabled').checked,
            environment: document.getElementById('flw_environment').value,
            credentials: {
              public_key: document.getElementById('flw_public_key').value,
              secret_key: document.getElementById('flw_secret_key').value,
              webhook_hash: document.getElementById('flw_webhook_hash').value
            }
          })
        });
        const result = await response.json();
        if (result.ok) {
          showToast('Flutterwave settings saved');
          updateProviderStatus('flw', document.getElementById('flw_enabled').checked);
        } else {
          showToast(result.message || 'Failed to save settings', 'error');
        }
      } catch (e) {
        showToast('Error saving settings', 'error');
      }
    });

    // Save Yo Payments settings
    document.getElementById('yopaymentsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const response = await fetch('/admin/api/payment-providers/yopayments', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            is_enabled: document.getElementById('yo_enabled').checked,
            environment: document.getElementById('yo_environment').value,
            credentials: {
              api_username: document.getElementById('yo_api_username').value,
              api_password: document.getElementById('yo_api_password').value,
              account_number: document.getElementById('yo_account_number').value
            }
          })
        });
        const result = await response.json();
        if (result.ok) {
          showToast('Yo Payments settings saved');
          updateProviderStatus('yo', document.getElementById('yo_enabled').checked);
        } else {
          showToast(result.message || 'Failed to save settings', 'error');
        }
      } catch (e) {
        showToast('Error saving settings', 'error');
      }
    });

    // Toggle change handlers
    document.getElementById('flw_enabled').addEventListener('change', function() {
      updateProviderStatus('flw', this.checked);
    });

    document.getElementById('yo_enabled').addEventListener('change', function() {
      updateProviderStatus('yo', this.checked);
    });

    // Load providers on page load
    loadPaymentProviders();

    // ============ MikroTik Settings ============

    // MikroTik toggle change handler
    document.getElementById('mikrotik_enabled').addEventListener('change', function() {
      updateMikrotikStatus(this.checked);
    });

    function updateMikrotikStatus(enabled) {
      const statusEl = document.getElementById('mikrotik-status');
      if (enabled) {
        statusEl.textContent = 'Enabled';
        statusEl.className = 'provider-status enabled';
      } else {
        statusEl.textContent = 'Disabled';
        statusEl.className = 'provider-status disabled';
      }
    }

    // Save MikroTik settings
    document.getElementById('mikrotikForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const data = {
          mikrotik_enabled: document.getElementById('mikrotik_enabled').checked ? 1 : 0,
          mikrotik_host: document.getElementById('mikrotik_host').value,
          mikrotik_port: parseInt(document.getElementById('mikrotik_port').value) || 8728,
          mikrotik_username: document.getElementById('mikrotik_username').value,
          mikrotik_password: document.getElementById('mikrotik_password').value,
          mikrotik_hotspot_server: document.getElementById('mikrotik_hotspot_server').value
        };

        const response = await fetch('/admin/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.ok) {
          showToast('MikroTik settings saved');
          updateMikrotikStatus(data.mikrotik_enabled);
        } else {
          showToast(result.message || 'Failed to save settings', 'error');
        }
      } catch (e) {
        showToast('Error saving settings', 'error');
      }
    });

    // Test MikroTik connection
    async function testMikrotikConnection() {
      const resultDiv = document.getElementById('mikrotikTestResult');
      const btn = document.getElementById('testMikrotikBtn');

      btn.disabled = true;
      btn.innerHTML = '<i data-lucide="loader"></i> Testing...';
      lucide.createIcons();

      resultDiv.style.display = 'block';
      resultDiv.style.background = 'var(--bg)';
      resultDiv.innerHTML = '<p>Connecting to MikroTik router...</p>';

      try {
        const response = await fetch('/admin/api/mikrotik/test');
        const result = await response.json();

        if (result.ok && result.result.success) {
          resultDiv.style.background = '#dcfce7';
          resultDiv.style.borderLeft = '4px solid #22c55e';
          resultDiv.innerHTML = `
            <p style="color: #166534; font-weight: 600; margin-bottom: 8px;">
              <i data-lucide="check-circle" style="width:18px;height:18px;display:inline;vertical-align:middle;margin-right:4px;"></i>
              Connection Successful!
            </p>
            <p style="color: #166534; margin: 0;">
              Router: <strong>${result.result.identity || 'Unknown'}</strong><br>
              Version: <strong>${result.result.version || 'Unknown'}</strong>
            </p>
          `;
        } else {
          resultDiv.style.background = '#fee2e2';
          resultDiv.style.borderLeft = '4px solid #ef4444';
          resultDiv.innerHTML = `
            <p style="color: #991b1b; font-weight: 600; margin-bottom: 8px;">
              <i data-lucide="x-circle" style="width:18px;height:18px;display:inline;vertical-align:middle;margin-right:4px;"></i>
              Connection Failed
            </p>
            <p style="color: #991b1b; margin: 0;">
              ${result.result?.message || result.message || 'Unable to connect to MikroTik router'}
            </p>
          `;
        }
        lucide.createIcons();
      } catch (e) {
        resultDiv.style.background = '#fee2e2';
        resultDiv.style.borderLeft = '4px solid #ef4444';
        resultDiv.innerHTML = `
          <p style="color: #991b1b; font-weight: 600;">
            <i data-lucide="x-circle" style="width:18px;height:18px;display:inline;vertical-align:middle;margin-right:4px;"></i>
            Error: ${e.message}
          </p>
        `;
        lucide.createIcons();
      }

      btn.disabled = false;
      btn.innerHTML = '<i data-lucide="wifi"></i> Test Connection';
      lucide.createIcons();
    }
  </script>
</body>
</html>
